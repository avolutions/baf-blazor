@using Avolutions.Baf.Blazor.Tabs.Abstractions
@using Avolutions.Baf.Blazor.Tabs.Models
@using Microsoft.Extensions.DependencyInjection
@using MudBlazor

@inject IServiceProvider Services;

<MudTabs ApplyEffectsToContainer="true"
         PanelClass="pa-4"
         Border="true">
    @foreach (var tab in _tabs)
    {
        <MudTabPanel Text="@tab.Title" BadgeData="@tab.BadgeCount">
            <CascadingValue Value="tab" IsFixed="true">
                <DynamicComponent Type="tab.ComponentType" Parameters="tab.Parameters"/>
            </CascadingValue>
        </MudTabPanel>
    }
</MudTabs>

@code {
    [Parameter] public IReadOnlyList<BafTabPanel> Tabs { get; set; } = [];
    
    private readonly List<IBafTab> _tabs = [];
    
    protected override async Task OnParametersSetAsync()
    {
        _tabs.Clear();

        foreach (var request in Tabs)
        {
            // Create each tab via DI + runtime args
            var tab = (IBafTab)ActivatorUtilities.CreateInstance(
                Services,
                request.TabType,
                request.Args ?? []
            );
            
            if (tab is BafTab concrete)
            {
                concrete.ReloadHandler = () => ReloadTabAsync(concrete);
            }
            
            _tabs.Add(tab);
            await tab.OnAddedAsync();
        }
    }
    
    private async Task ReloadTabAsync(IBafTab tab)
    {
        await tab.OnAddedAsync();
        await InvokeAsync(StateHasChanged);
    }
}